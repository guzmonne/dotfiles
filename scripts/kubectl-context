#!/usr/bin/env bash

contexts=$(kubectl config get-contexts | awk '{print $2}' | tail -n '+2')

if [[ -n "$1" ]]; then
  grep_contexts=$(echo "$contexts" | grep "$1")
  echo $grep_contexts
  if [[ "$(echo $grep_contexts | wc -l | tr -d ' ')" -eq 1 ]]; then
    config="$grep_contexts"
  fi
fi

if [[ -z "$config" ]]; then
  config=$(fzf-tmux -p 80%,40% <<<"$contexts")
fi

if [ -z "$config" ]; then exit 0; fi

clear

hr.sh '─'

kubectl config use-context $config

dotenv -f ~/.config/ohmyposh/.env set OHMYPOSH_KUBERNETES_CONTEXT=" $(echo $config | sed -e 's/[^_]*_[^_]*_[^_]*_//')"

printf "\nUsing $config context\n"

hr.sh '─'
